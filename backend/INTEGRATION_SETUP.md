# Настройка интеграции с Bitrix24 и M2Lab

## Шаг 1: Установка зависимостей

Axios уже установлен. Если нужно переустановить:

```bash
cd backend
npm install axios
```

## Шаг 2: Настройка переменных окружения

Откройте файл `backend/.env` и добавьте следующие переменные:

```env
# BITRIX24 SETTINGS
# Сгенерируйте вебхук в Битрикс24:
# Маркет -> Разработчикам -> Другое -> Входящий вебхук
# Права: CRM (crm)
BITRIX_WEBHOOK_URL=https://ваша_компания.bitrix24.ru/rest/1/ваш_код/crm.lead.add.json

# M2LAB SETTINGS
# (Примерные настройки, зависят от документации M2Lab)
M2LAB_API_URL=https://api.m2lab.ru/v1/leads
M2LAB_API_KEY=ваш_ключ_m2lab
```

### Как получить вебхук Bitrix24:

1. Войдите в ваш Bitrix24
2. Перейдите в **Маркет** → **Разработчикам** → **Другое** → **Входящий вебхук**
3. Выберите права: **CRM (crm)**
4. Скопируйте URL вебхука и вставьте в `BITRIX_WEBHOOK_URL`

### Настройка M2Lab:

Свяжитесь с M2Lab для получения:
- URL API (`M2LAB_API_URL`)
- API ключ (`M2LAB_API_KEY`)
- Структуру запроса (может отличаться от примера)

## Шаг 3: Настройка прав доступа в Strapi

1. Откройте Strapi Admin панель
2. Перейдите в **Settings** → **Users & Permissions** → **Roles** → **Public**
3. Найдите коллекцию **Lead**
4. Включите разрешение **create** (создание заявок)

## Шаг 4: Перезапуск Strapi

После настройки переменных окружения перезапустите Strapi:

```bash
cd backend
npm run develop
```

## Проверка работы

1. **Отправьте тестовую заявку** через форму на сайте
2. **Проверьте Strapi**: Content Manager → Leads - заявка должна появиться
3. **Проверьте Bitrix24**: CRM → Лиды - лид должен появиться через 1-2 секунды
4. **Проверьте M2Lab**: согласно их документации

## Логирование

Все операции логируются в консоль Strapi:
- Успешная отправка: `[Lead] Lead {id} sent to Bitrix24/M2Lab`
- Ошибки: `[Lead] Failed to send lead {id} to Bitrix24/M2Lab: {error}`

## Безопасность

✅ API ключи хранятся в `.env` на сервере  
✅ Ключи не попадают в браузер пользователя  
✅ Заявки сохраняются в Strapi даже если внешние API недоступны

