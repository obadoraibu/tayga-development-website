# Диагностика ошибок формы заявок

## Проверка ошибок

### 1. Откройте консоль браузера (F12)
Проверьте логи:
- `[Form] Sending lead:` - показывает, какие данные отправляются
- `[API] Fetching:` - показывает URL запроса
- `[API] POST body:` - показывает тело запроса
- `[Form] Response:` - показывает ответ от сервера
- `[Form] Error sending lead:` - показывает детали ошибки

### 2. Проверьте права доступа в Strapi

1. Откройте Strapi Admin: `http://localhost:1337/admin`
2. Перейдите: **Settings** → **Users & Permissions** → **Roles** → **Public**
3. Найдите коллекцию **Lead**
4. Убедитесь, что включено разрешение **create** (создание)

### 3. Проверьте, запущен ли Strapi

```bash
cd backend
npm run develop
```

Strapi должен быть доступен по адресу: `http://localhost:1337`

### 4. Проверьте переменные окружения

Убедитесь, что в `frontend/.env.local` (или `.env`) указан правильный URL Strapi:

```env
NEXT_PUBLIC_STRAPI_API_URL=http://localhost:1337
```

### 5. Типичные ошибки

#### Ошибка 403 Forbidden
**Причина:** Не настроены права доступа в Strapi  
**Решение:** Включите `create` для коллекции Lead в роли Public

#### Ошибка 404 Not Found
**Причина:** Неправильный URL или коллекция не создана  
**Решение:** 
- Проверьте, что коллекция Lead создана в Strapi
- Перезапустите Strapi после создания коллекции

#### Ошибка Network/CORS
**Причина:** Strapi не запущен или неправильный URL  
**Решение:** 
- Убедитесь, что Strapi запущен
- Проверьте URL в переменных окружения

#### Ошибка 400 Bad Request
**Причина:** Неправильный формат данных  
**Решение:** Проверьте логи в консоли, убедитесь что все обязательные поля заполнены

### 6. Тестирование через curl

Проверьте, работает ли API напрямую:

```bash
curl -X POST http://localhost:1337/api/leads \
  -H "Content-Type: application/json" \
  -d '{
    "data": {
      "name": "Test User",
      "phone": "+79991234567",
      "source": "Test"
    }
  }'
```

Если запрос успешен, вы получите ответ с данными созданной заявки.

### 7. Проверка логов Strapi

В консоли Strapi должны быть логи:
- `[Lead] Lead {id} sent to Bitrix24` - успешная отправка в Bitrix24
- `[Lead] Lead {id} sent to M2Lab` - успешная отправка в M2Lab
- `[Lead] Failed to send lead {id} to Bitrix24/M2Lab` - ошибка отправки

Если видите ошибки интеграции, проверьте переменные окружения в `backend/.env`.

